#!/usr/bin/env sh

# Check for emergency bypass
if [ "$HUSKY_SKIP_HOOKS" = "1" ] || [ "$EMERGENCY_BYPASS" = "1" ]; then
  echo "üö® SECURITY HOOKS BYPASSED - EMERGENCY MODE"
  echo "   Reason should be documented in emergency bypass log"
  exit 0
fi

# Start performance monitoring
yarn perf-monitor start pre-push

# Pre-push security validation hook
echo "üîí Running comprehensive security validation before push..."

success=true

# Get the remote and branch information
remote="$1"
url="$2"

# Run comprehensive security checks
echo "üìã Running npm security audit..."
if ! yarn npm audit --severity moderate > /dev/null 2>&1; then
    echo "‚ùå Security audit failed. Please fix vulnerabilities before pushing."
    success=false
fi

# Run dependency vulnerability scans (skip if no auth)
echo "üîç Running snyk dependency vulnerability scans..."
yarn snyk:test > /dev/null 2>&1 || echo "‚ö†Ô∏è  Snyk scan skipped (authentication required)"

# Run OSV scan
echo "üåê Running OSV vulnerability scan..."
yarn osv:scan > /dev/null 2>&1 || echo "‚ö†Ô∏è  OSV scan completed"

# Run code security scanning
echo "üîé Running semgrep code security analysis..."
if ! yarn semgrep:scan > /dev/null 2>&1; then
    echo "‚ùå Code security scan found issues. Please fix before pushing."
    success=false
fi

# Run Solidity static analysis with Slither
echo "üêç Running Solidity static analysis with Slither..."
if ! yarn slither:scan > /dev/null 2>&1; then
    echo "‚ùå Slither analysis found issues. Please fix before pushing."
    success=false
fi

# Run secret detection
echo "üîë Running secret detection..."
if ! yarn git-secrets:scan > /dev/null 2>&1; then
    echo "‚ùå Secret detection found potential leaks. Please review before pushing."
    success=false
fi

# Run tests if pushing to main/develop branches
current_branch=$(git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
if [ "$current_branch" = "main" ] || [ "$current_branch" = "develop" ]; then
    echo "üß™ Running tests for protected branch push..."
    if ! yarn test > /dev/null 2>&1; then
        echo "‚ùå Tests failed. Please fix tests before pushing to protected branch."
        success=false
    fi
fi

if [ "$success" = true ]; then
    echo "‚úÖ All security validations passed. Push proceeding..."
    yarn perf-monitor end true
else
    echo "‚ùå Security validations failed. Push blocked."
    yarn perf-monitor end false
    exit 1
fi
